services:
  app:
    image: ghcr.io/d3mocide/meshrf:latest
    container_name: meshrf
    ports:
      - "80:80"
    environment:
      # Hostname for reverse proxy
      - ALLOWED_HOSTS=localhost
      # Default Map Center (Bellingham, WA)
      - VITE_MAP_LAT=48.7519
      - VITE_MAP_LNG=-122.4787
      # UI Defaults (Runtime Configurable)
      - DEFAULT_MAP_STYLE=dark_green
      - DEFAULT_UNITS=imperial
    restart: always
    networks:
      - meshrf_net

  rf-engine:
    build: ./rf-engine
    container_name: rf_engine
    ports:
      - "5001:5001"
    volumes:
      - ./rf-engine:/app:z
      - ./cache:/app/cache:z
    environment:
      # Elevation Data Configuration
      - ELEVATION_API_URL=http://opentopodata:5000
      - ELEVATION_DATASET=${ELEVATION_DATASET:-ned10m}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-changeme}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # MeshCore API
      - MESHCORE_API_URL=https://api.meshcore.nz/api/v1/map/nodes
      # Bellingham PNW bounding box
      - PNW_BBOX_NORTH=49.5
      - PNW_BBOX_SOUTH=47.0
      - PNW_BBOX_EAST=-120.5
      - PNW_BBOX_WEST=-124.0
      # Gateway anchor
      - GATEWAY_LAT=48.7519
      - GATEWAY_LON=-122.4787
      - GATEWAY_NAME=2000 Huron St Gateway
    command: sh -c "cd /app && uvicorn server:app --host 0.0.0.0 --port 5001 --log-level info"
    restart: unless-stopped
    depends_on:
      - redis
    networks:
      - meshrf_net

  rf-worker:
    image: ghcr.io/d3mocide/meshrf-rf-engine:latest
    container_name: rf_worker
    command: celery -A worker.celery_app worker --loglevel=info
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - ELEVATION_API_URL=http://opentopodata:5000
      - ELEVATION_DATASET=${ELEVATION_DATASET:-ned10m}
      - REDIS_PASSWORD=${REDIS_PASSWORD:-changeme}
    volumes:
      - ./cache:/app/cache:z
    restart: unless-stopped
    depends_on:
      - rf-engine
      - redis
    networks:
      - meshrf_net

  redis:
    image: redis:alpine
    user: nobody
    command: redis-server --requirepass ${REDIS_PASSWORD:-changeme}
    volumes:
      - ./redis_data:/data
    restart: always
    networks:
      - meshrf_net

  opentopodata:
    image: ghcr.io/d3mocide/meshrf-opentopodata:latest
    container_name: opentopodata
    volumes:
      - ./data/opentopodata:/app/data:z
      - ./data/opentopodata/config.yaml:/app/config.yaml:z
    restart: unless-stopped
    networks:
      - meshrf_net

networks:
  meshrf_net:
    driver: bridge
